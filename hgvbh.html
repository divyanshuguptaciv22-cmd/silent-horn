<!doctype html>
<html>
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1.0"/>
<title>Silent Horn — Permissions Fixed</title>
<style>
  :root{--orange:#ff6600;--muted:#cfcfcf;--bg:#0b0b0b}
  body{margin:0;font-family:Inter,system-ui,Roboto,Arial;background:linear-gradient(180deg,#070707,#0b0b0b);color:var(--muted)}
  .wrap{max-width:920px;margin:18px auto;padding:18px;border-radius:12px;background:linear-gradient(180deg,#0a0a0a,#151515);box-shadow:0 10px 40px rgba(0,0,0,0.6)}
  header{display:flex;align-items:center;gap:12px}
  .title{color:var(--orange);font-weight:800;font-size:20px}
  .controls{display:flex;gap:8px;flex-wrap:wrap;margin-top:12px}
  button{background:var(--orange);color:#111;border:0;padding:10px 14px;border-radius:10px;font-weight:700;cursor:pointer}
  button.muted{opacity:0.6;background:#333;color:var(--muted)}
  .center{display:flex;flex-direction:column;align-items:center;gap:14px;padding:18px}
  .distanceCard{width:320px;height:220px;border-radius:14px;background:linear-gradient(180deg,#0f0f0f,#111);display:flex;flex-direction:column;align-items:center;justify-content:center;box-shadow:0 12px 30px rgba(0,0,0,0.6);border:1px solid rgba(255,102,0,0.06)}
  .distanceVal{font-size:64px;font-weight:900;color:#fff}
  .distanceNote{font-size:13px;color:#bbb;margin-top:8px}
  .metaRow{display:flex;gap:12px;justify-content:center;margin-top:10px}
  .meta{background:#0a0a0a;padding:8px 12px;border-radius:10px;color:#bbb;font-weight:700}
  .arrowBox{width:140px;height:140px;border-radius:50%;border:6px solid rgba(255,255,255,0.03);display:flex;align-items:center;justify-content:center;margin-top:6px;position:relative}
  #needle{width:6px;height:60px;background:var(--orange);position:absolute;bottom:35%;border-radius:6px;transform-origin:50% 90%;transition:transform 260ms cubic-bezier(.2,.9,.2,1)}
  #debug{width:100%;height:120px;margin-top:12px;background:#080808;color:#9fff9f;padding:8px;border-radius:8px;font-family:monospace;font-size:12px;overflow:auto}
  .hint{color:#aaa;font-size:13px;margin-top:8px}
  .statusLine{margin-top:8px;font-size:13px;color:#ddd}
  body.fast-flash{transition:background 0s !important}
</style>
</head>
<body>
<div class="wrap">
  <header>
    <div>
      <div class="title">Silent Horn</div>
      <div style="color:#bbb;font-size:12px">Permissions and Distance-focused Prototype</div>
    </div>
  </header>

  <div class="controls">
    <button id="reqPerm">Enable Location & Orientation</button>
    <button id="enableAudio" class="muted">Enable Audio</button>
    <button id="testTone" class="muted">Play Test Tone</button>
    <button id="horn" style="margin-left:auto;background:#ff3b30">HORN</button>
  </div>

  <div class="center">
    <div class="distanceCard" id="distanceCard" aria-live="polite">
      <div class="distanceVal" id="distanceVal">—</div>
      <div class="distanceNote" id="distanceNote">Waiting for GPS & permissions...</div>
    </div>

    <div class="metaRow">
      <div class="meta">Your ID: <span id="myid">...</span></div>
      <div class="meta">Last from: <span id="lastFrom">—</span></div>
      <div class="meta">Status: <span id="status">Idle</span></div>
    </div>

    <div class="arrowBox" title="Approx. absolute bearing (visual only)">
      <div id="needle" style="transform:rotate(0deg)"></div>
    </div>

    <div class="statusLine" id="permStatus">Permissions: Not requested</div>
    <div class="hint">Note: Use HTTPS or localhost — file:// and WhatsApp viewers block sensors.</div>

    <pre id="debug">debug ready...</pre>
  </div>
</div>

<!-- audio -->
<audio id="alertSound" preload="auto">
  <source src="data:audio/wav;base64,UklGRiQAAABXQVZFZm10IBAAAAABAAEAESsAACJWAAACABAAZGF0YQAAAAA=">
</audio>

<!-- Firebase compat -->
<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>

<script>
/* ====== CONFIG (keep your Firebase values) ====== */
const FIREBASE_CONFIG = {
  apiKey: "AIzaSyDEqx20Id0d8_hayEhk-syuUVNshHUjxcw",
  authDomain: "silent-a7aae.firebaseapp.com",
  databaseURL: "https://silent-a7aae-default-rtdb.firebaseio.com",
  projectId: "silent-a7aae",
  storageBucket: "silent-a7aae.firebasestorage.app",
  messagingSenderId: "333807832648",
  appId: "1:333807832648:web:f26dc85699b30a6301927d"
};
const TUNING = { gpsAlpha:0.35, positionWindow:5, alertDistanceM:20, dedupMs:700, extrapolateMs:300 };
/* =============================================== */

firebase.initializeApp(FIREBASE_CONFIG);
const db = firebase.database();

/* UI refs */
const reqPermBtn = document.getElementById('reqPerm');
const enableAudioBtn = document.getElementById('enableAudio');
const testToneBtn = document.getElementById('testTone');
const hornBtn = document.getElementById('horn');
const permStatus = document.getElementById('permStatus');
const distanceVal = document.getElementById('distanceVal');
const distanceNote = document.getElementById('distanceNote');
const distanceCard = document.getElementById('distanceCard');
const lastFrom = document.getElementById('lastFrom');
const statusEl = document.getElementById('status');
const debugEl = document.getElementById('debug');
const needle = document.getElementById('needle');
const myidEl = document.getElementById('myid');

let myId = 'p' + Math.floor(Math.random()*9000+1000);
myidEl.textContent = myId;

/* state */
let posWindow = [];
let smoothDistance = null;
let lastEvent = {};
let audioUnlocked = false;
let watchId = null;

/* debug helper */
function dbg(...args){ debugEl.textContent = new Date().toLocaleTimeString() + ' ▶ ' + args.join(' ') + '\n' + debugEl.textContent; }

/* strong flash helper */
function strongFlash(){
  document.body.classList.add('fast-flash');
  document.body.style.background = '#ffffff';
  setTimeout(()=> document.body.style.background = '#ff6600', 80);
  setTimeout(()=> { document.body.style.background = ''; setTimeout(()=>document.body.classList.remove('fast-flash'),50); }, 260);
}

/* rotation helper */
let currentNeedleAngle = 0;
function rotateNeedle(angle){
  angle = ((angle%360)+360)%360;
  const diff = ((angle - currentNeedleAngle + 540) % 360) - 180;
  currentNeedleAngle = (currentNeedleAngle + diff);
  needle.style.transform = `rotate(${currentNeedleAngle}deg)`;
}

/* EMA */
function ema(prev, v, alpha){ if (prev==null) return v; return prev*(1-alpha)+v*alpha; }

/* avg position */
function avgPosition(){
  if (posWindow.length===0) return null;
  let sx=0, sy=0, sa=0;
  posWindow.forEach(p=>{ sx+=p.lat; sy+=p.lon; sa+=p.acc||100; });
  return {lat: sx/posWindow.length, lon: sy/posWindow.length, acc: sa/posWindow.length, t: posWindow[posWindow.length-1].t};
}

/* geodesy */
function toRad(d){ return d*Math.PI/180; }
function toDeg(r){ return r*180/Math.PI; }
function distanceMeters(lat1,lon1,lat2,lon2){
  const R=6371000; const dLat=toRad(lat2-lat1), dLon=toRad(lon2-lon1);
  const a = Math.sin(dLat/2)**2 + Math.cos(toRad(lat1))*Math.cos(toRad(lat2))*Math.sin(dLon/2)**2;
  const c = 2*Math.atan2(Math.sqrt(a), Math.sqrt(1-a)); return R*c;
}
function bearingDegrees(lat1,lon1,lat2,lon2){
  const φ1=toRad(lat1), φ2=toRad(lat2), Δλ=toRad(lon2-lon1);
  const y=Math.sin(Δλ)*Math.cos(φ2), x=Math.cos(φ1)*Math.sin(φ2)-Math.sin(φ1)*Math.cos(φ2)*Math.cos(Δλ);
  return (toDeg(Math.atan2(y,x))+360)%360;
}

/* ===== permission flow =====
   - Request DeviceOrientation permission on iOS (if required)
   - Prompt getCurrentPosition to show location permission
   - Use navigator.permissions.query if available to read state
*/
async function requestPermissions(){
  permStatus.textContent = 'Requesting permissions...';
  dbg('starting permission flow');

  // 1) DeviceOrientation (iOS)
  if (typeof DeviceOrientationEvent !== 'undefined' && typeof DeviceOrientationEvent.requestPermission === 'function') {
    try {
      const res = await DeviceOrientationEvent.requestPermission();
      dbg('DeviceOrientation permission', res);
      if (res !== 'granted') {
        permStatus.textContent = 'Orientation permission denied';
      } else {
        permStatus.textContent = 'Orientation granted';
      }
    } catch(e){
      dbg('orientation request failed', e && e.message);
      permStatus.textContent = 'Orientation request failed';
    }
  } else {
    dbg('no DeviceOrientation.requestPermission() needed');
  }

  // 2) Geolocation: trigger prompt via getCurrentPosition
  if (!navigator.geolocation) {
    dbg('no geolocation API');
    permStatus.textContent = 'Geolocation API not available';
    return;
  }

  // Show a temporary prompt attempt to trigger permission dialog
  try {
    await new Promise((resolve, reject) => {
      let done=false;
      navigator.geolocation.getCurrentPosition(pos=>{
        dbg('getCurrentPosition OK', pos.coords.latitude.toFixed(6), pos.coords.longitude.toFixed(6));
        if (!done){ done=true; resolve(pos); }
      }, err=>{
        dbg('getCurrentPosition err', err && err.message);
        if (!done){ done=true; reject(err); }
      }, { enableHighAccuracy:true, timeout:8000, maximumAge:0 });
      // safety timeout
      setTimeout(()=>{ if (!done){ done=true; reject(new Error('timeout')); } }, 9000);
    });
    permStatus.textContent = 'Location permission granted';
  } catch(e){
    dbg('getCurrentPosition failed', e && e.message);
    permStatus.textContent = 'Location permission denied or timed out';
    // if permission denied, try to read permissions API to show guidance
    if (navigator.permissions && navigator.permissions.query) {
      try {
        const p = await navigator.permissions.query({name:'geolocation'});
        dbg('permissions state', p.state);
        if (p.state === 'denied') {
          permStatus.textContent = 'Location denied — open site settings to allow';
        } else if (p.state === 'prompt') {
          permStatus.textContent = 'Location permission prompt dismissed — try again';
        }
      } catch(_) {}
    }
    return;
  }

  // 3) start watchPosition now that permission is likely granted
  startWatchPosition();
  permStatus.textContent = 'Permissions granted — GPS active';
}

/* watch position: sliding window */
function startWatchPosition(){
  if (!navigator.geolocation) { dbg('no geolocation'); statusEl.textContent='No GPS'; return; }
  if (watchId != null) return;
  watchId = navigator.geolocation.watchPosition(p=>{
    const pt = {lat:p.coords.latitude, lon:p.coords.longitude, acc:p.coords.accuracy, t:Date.now()};
    posWindow.push(pt);
    if (posWindow.length > TUNING.positionWindow) posWindow.shift();
    dbg('pos', pt.lat.toFixed(6), pt.lon.toFixed(6), 'acc', Math.round(pt.acc));
  }, err=>{
    dbg('watchPosition err', err && err.message);
    permStatus.textContent = 'GPS error: ' + (err && err.message);
  }, { enableHighAccuracy:true, maximumAge:1000, timeout:5000 });
}

/* audio unlock */
const alertSound = document.getElementById('alertSound');
enableAudioBtn.addEventListener('click', async ()=>{
  try{
    await alertSound.play(); alertSound.pause(); alertSound.currentTime=0;
    audioUnlocked=true; enableAudioBtn.classList.add('muted'); enableAudioBtn.textContent='Audio Enabled';
    dbg('audio unlocked');
  }catch(e){ dbg('audio unlock failed', e && e.message); }
});
testToneBtn.addEventListener('click', ()=> {
  if (audioUnlocked) alertSound.play().catch(e=>dbg('play', e && e.message));
  else { alertSound.play().catch(()=>navigator.vibrate && navigator.vibrate(200)); dbg('vibrate fallback'); }
});

/* DB listener (distance-only, smoothing) */
const hornsRef = db.ref('horns');
hornsRef.limitToLast(50).on('child_added', snap=>{
  const data = snap.val();
  if (!data) return;
  const sender = data.senderId;
  const now = Date.now();
  if ((lastEvent[sender]||0) + TUNING.dedupMs > now){ dbg('dedup', sender); return; }
  lastEvent[sender]=now;
  dbg('horn received', sender, 'ts', data.timestamp);
  handleHorn(data);
});

function handleHorn(data){
  lastFrom.textContent = data.senderId + ' @ ' + new Date(data.timestamp).toLocaleTimeString();
  const own = avgPosition();
  if (!own){ dbg('no own pos'); distanceVal.textContent='—'; distanceNote.textContent='Waiting for GPS fix...'; strongFlash(); navigator.vibrate && navigator.vibrate(120); return; }

  // extrapolate sender if speed+heading info present
  let sLat = data.lat, sLon = data.lon;
  if (data.heading != null && data.speed != null && data.timestamp){
    const ageMs = Date.now() - data.timestamp + TUNING.extrapolateMs;
    const dt = Math.max(0, ageMs)/1000;
    const d = (data.speed || 0) * dt;
    const R = 6371000;
    const brng = toRad(data.heading);
    const lat1 = toRad(sLat), lon1 = toRad(sLon);
    const lat2 = Math.asin(Math.sin(lat1)*Math.cos(d/R) + Math.cos(lat1)*Math.sin(d/R)*Math.cos(brng));
    const lon2 = lon1 + Math.atan2(Math.sin(brng)*Math.sin(d/R)*Math.cos(lat1), Math.cos(d/R)-Math.sin(lat1)*Math.sin(lat2));
    sLat = lat2*180/Math.PI; sLon = lon2*180/Math.PI;
  }

  const rawDist = Math.round(distanceMeters(own.lat, own.lon, sLat, sLon));
  const rawBear = bearingDegrees(own.lat, own.lon, sLat, sLon);
  rotateNeedle(rawBear);

  smoothDistance = ema(smoothDistance, rawDist, TUNING.gpsAlpha);
  distanceVal.textContent = Math.round(smoothDistance);
  distanceNote.textContent = `Approx distance • GPS acc: ${Math.round(own.acc)} m`;

  if (smoothDistance <= TUNING.alertDistanceM){
    distanceCard.classList.add('alert');
    strongFlash();
    if (audioUnlocked) alertSound.play().catch(()=>navigator.vibrate && navigator.vibrate(180));
    else navigator.vibrate && navigator.vibrate([200,80,200]);
  } else {
    distanceCard.classList.remove('alert');
    // subtle feedback still
    if (audioUnlocked) alertSound.play().catch(()=>{});
  }

  dbg('rawDist', rawDist, 'smooth', Math.round(smoothDistance), 'bear', Math.round(rawBear));
}

/* send horn */
hornBtn.addEventListener('click', ()=>{
  const own = avgPosition();
  const payload = {
    type:'horn', senderId: myId, timestamp: Date.now(),
    lat: own ? own.lat : null, lon: own ? own.lon : null, heading: null, speed: null
  };
  db.ref('horns').push(payload).then(()=> { dbg('horn sent', payload); if (audioUnlocked) alertSound.play().catch(()=>{}); else navigator.vibrate && navigator.vibrate(120); }).catch(e=> dbg('send failed', e && e.message));
});

/* wire up request permissions button */
reqPermBtn.addEventListener('click', requestPermissions);

/* initial debug */
dbg('Permissions-ready app loaded. Click "Enable Location & Orientation" to start.');
</script>
</body>
</html>
